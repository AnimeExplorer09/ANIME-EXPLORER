<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Chat & Follow</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="components.css">
    <style>
        :root { --primary: #7c4dff; --bg: #0b0c10; --card: #161b22; --text: #8b949e; --bg-card: #1d1f23; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; outline: none; }
        body { margin: 0; background: var(--bg); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- SEARCH BAR --- */
        .search-container { padding: 15px; background: var(--card); border-bottom: 1px solid #333; }
        .search-box { display: flex; align-items: center; background: #000; padding: 12px 15px; border-radius: 12px; border: 1px solid #444; }
        .search-box input { flex: 1; background: transparent; border: none; color: white; margin-left: 10px; font-size: 14px; }
        
        #searchOverlay { position: absolute; top: 80px; left: 0; width: 100%; bottom: 80px; background: var(--bg); z-index: 1500; display: none; overflow-y: auto; padding: 10px; }

        /* --- TABS --- */
        .tabs { display: flex; padding: 10px; gap: 10px; background: var(--bg); }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; background: #21262d; color: var(--text); font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* --- CARDS --- */
        .item-card { display: flex; align-items: center; padding: 12px; background: var(--card); border-radius: 15px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .pfp { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .meta { flex: 1; margin-left: 12px; overflow: hidden; }
        .meta h4 { margin: 0; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .meta p { margin: 2px 0 0; font-size: 11px; color: var(--text); }
        
        /* Buttons Style */
        .action-btn { padding: 6px 15px; border-radius: 8px; border: none; color: white; font-size: 12px; font-weight: bold; cursor: pointer; }
        .follow-btn { background: var(--primary); }
        .join-btn { background: #00c853; }
        .joined-btn { background: #333; color: #888; cursor: default; }

        /* --- BOTTOM NAV --- */
/* FIXED UNIFORM BOTTOM NAV */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 70px;
    display: flex;
    justify-content: space-around;
    align-items: center;
    background: #1a1c22;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: env(safe-area-inset-bottom);
    z-index: 2000; /* Chat screen (2500) ke niche rahega */
}

.nav-item {
    text-decoration: none;
    color: #94a3b8;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    gap: 4px;
    transition: 0.2s ease;
}

.nav-item i {
    font-size: 20px;
}

.nav-item span {
    font-size: 10px;
    font-weight: 600;
}

/* Chat page active color */
.nav-item.active {
    color: #7c4dff; /* Chat page ka primary purple */
}

.nav-item:active {
    transform: scale(0.9);
}

/* Keyboard open hone par list ko space dene ke liye */
#directArea, #groupsArea {
    padding-bottom: 80px; 
}


        /* --- CHAT BOX --- */
        #chatScreen { position: fixed; inset: 0; background: var(--bg); z-index: 2500; display: none; flex-direction: column; }
        #chatScreen.active { display: flex; }
        .chat-header { padding: 15px; background: var(--card); display: flex; align-items: center; border-bottom: 1px solid #333; }
        .msg-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; padding-bottom: 80px; }
        .input-bar { padding: 15px 15px 35px; background: #161b22; display: flex; gap: 12px; align-items: center; }
        .input-bar input { flex: 1; background: #000; border: 1px solid #444; border-radius: 25px; padding: 12px 18px; color: white; }

        .bubble { max-width: 75%; padding: 10px 16px; border-radius: 18px; font-size: 14px; line-height: 1.4; }
        .me { align-self: flex-end; background: var(--primary); border-bottom-right-radius: 2px; }
        .other { align-self: flex-start; background: #333; border-top-left-radius: 2px; }

        .fab { position: fixed; bottom: 85px; right: 20px; width: 50px; height: 50px; background: var(--primary); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; font-size: 20px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 99; }
    </style>
</head>
<body>

    <div class="search-container">
        <div class="search-box">
            <i class="fa-solid fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search ID or Name..." oninput="realtimeSearch(this.value)">
        </div>
    </div>

    <div id="searchOverlay"></div>

    <div class="tabs">
        <button class="tab-btn active" id="tDirect" onclick="setView('direct')"><i class="fa-solid fa-paper-plane"></i> Direct</button>
        <button class="tab-btn" id="tGroups" onclick="setView('groups')"><i class="fa-solid fa-users"></i> Groups</button>
    </div>

    <div id="directArea" class="msg-list" style="flex:1;"></div>
    <div id="groupsArea" class="msg-list" style="flex:1; display:none;"></div>
    
    <button id="addGroupBtn" class="fab" onclick="createGroup()"><i class="fa-solid fa-plus"></i></button>

<nav class="bottom-nav">
    <a href="index.html" class="nav-item">
        <i class="fa-solid fa-compass"></i>
        <span>Home</span>
    </a>
    <a href="watchlist.html" class="nav-item">
        <i class="fa-solid fa-bookmark"></i>
        <span>List</span>
    </a>
    <a href="poll.html" class="nav-item">
        <i class="fa-solid fa-chart-simple"></i>
        <span>Polls</span>
    </a>
    <a href="chat.html" class="nav-item active">
        <i class="fa-solid fa-comments"></i>
        <span>Chat</span>
    </a>
    <a href="profile.html" class="nav-item">
        <i class="fa-solid fa-user"></i>
        <span>Profile</span>
    </a>
</nav>


    <div id="chatScreen">
        <div class="chat-header">
            <i class="fa-solid fa-arrow-left" onclick="closeChat()" style="padding:10px; font-size:20px;"></i>
            <img id="chatPfp" class="pfp" style="width:38px; height:38px; margin-left:10px;">
            <div style="margin-left:12px;">
                <div id="chatName" style="font-weight:bold;">User</div>
                <div id="chatId" style="font-size:10px; color:var(--primary);">ID: ---</div>
            </div>
        </div>
        <div id="msgStream" class="msg-list"></div>
        <div class="input-bar">
            <label for="imgInp"><i class="fa-solid fa-circle-plus" style="font-size:26px; color:var(--primary); cursor:pointer;"></i></label>
            <input type="file" id="imgInp" hidden accept="image/*" onchange="uploadImage(this)">
            <input type="text" id="typeBox" placeholder="Message...">
            <button id="sendBtn" style="background:none; border:none; color:var(--primary); font-size:22px;"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, doc, getDocs, getDoc, setDoc, addDoc, serverTimestamp, orderBy, updateDoc, arrayUnion, arrayRemove, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyDLd3TW-y89lwShUmcIHw3YGzDjo4cg3y4", authDomain: "animea2z.firebaseapp.com", projectId: "animea2z", storageBucket: "animea2z.firebasestorage.app", messagingSenderId: "673605765684", appId: "1:673605765684:web:a6f851e0d79836b79b1861" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let me = null, activeRoom = null, msgUnsub = null;

        onAuthStateChanged(auth, u => { if(u){ me=u; loadDirects(); loadGroups(); } else { window.location.href="login.html"; }});

        window.setView = (v) => {
            document.getElementById('directArea').style.display = v === 'direct' ? 'flex' : 'none';
            document.getElementById('groupsArea').style.display = v === 'groups' ? 'flex' : 'none';
            document.getElementById('addGroupBtn').style.display = v === 'groups' ? 'flex' : 'none';
            document.getElementById('tDirect').classList.toggle('active', v === 'direct');
            document.getElementById('tGroups').classList.toggle('active', v === 'groups');
        };

        window.uploadImage = async (input) => {
            const file = input.files[0];
            if (!file || !activeRoom) return;
            const box = document.getElementById('typeBox');
            box.placeholder = "Uploading...";
            const fd = new FormData();
            fd.append('file', file);
            fd.append('upload_preset', 'anime_chat_preset');
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/dw2j3sgsd/image/upload`, { method: 'POST', body: fd });
                const data = await res.json();
                if (data.secure_url) {
                    const type = document.getElementById('chatId').innerText === 'Public' ? 'groups' : 'chats';
                    await addDoc(collection(db, type, activeRoom, "messages"), { senderId: me.uid, image: data.secure_url, createdAt: serverTimestamp() });
                }
            } catch (err) { alert("Failed!"); }
            box.placeholder = "Message...";
            input.value = "";
        };

        window.realtimeSearch = async (val) => {
            const overlay = document.getElementById('searchOverlay');
            if(val.length < 2) { overlay.style.display = 'none'; return; }
            overlay.style.display = 'block';
            const q = query(collection(db, "users"), limit(15));
            const snap = await getDocs(q);
            const myData = (await getDoc(doc(db, "users", me.uid))).data();
            const following = myData.following || [];
            overlay.innerHTML = '';
            snap.forEach(uDoc => {
                const u = uDoc.data();
                if(u.uid === me.uid) return;
                if(u.username.toLowerCase().includes(val.toLowerCase()) || (u.customId && u.customId.includes(val))) {
                    const isFollowing = following.includes(u.uid);
                    const div = document.createElement('div');
                    div.className = 'item-card';
                    div.innerHTML = `<img src="${u.avatar || 'https://via.placeholder.com/50'}" class="pfp" onclick="startChat('${u.uid}','${u.username}','${u.avatar}','${u.customId}')"><div class="meta" onclick="startChat('${u.uid}','${u.username}','${u.avatar}','${u.customId}')"><h4>${u.username}</h4><p>ID: ${u.customId}</p></div><button class="action-btn follow-btn" onclick="toggleFollow('${u.uid}', ${isFollowing})" style="background:${isFollowing?'#333':''}"> ${isFollowing ? 'Unfollow' : 'Follow'} </button>`;
                    overlay.appendChild(div);
                }
            });
        };

        window.toggleFollow = async (uid, isFollowing) => {
            const myRef = doc(db, "users", me.uid);
            const targetRef = doc(db, "users", uid);
            if(isFollowing) { await updateDoc(myRef, { following: arrayRemove(uid) }); await updateDoc(targetRef, { followers: arrayRemove(me.uid) }); } 
            else { await updateDoc(myRef, { following: arrayUnion(uid) }); await updateDoc(targetRef, { followers: arrayUnion(me.uid) }); }
            realtimeSearch(document.getElementById('searchInput').value);
        };

        window.startChat = async (uid, name, pfp, cid) => {
            const rid = [me.uid, uid].sort().join("_");
            const mySnap = await getDoc(doc(db, "users", me.uid));
            await setDoc(doc(db, "chats", rid), { participants: [me.uid, uid], lastMsg: "Connected", uData: { [me.uid]: { name: mySnap.data().username, pfp: mySnap.data().avatar || "" }, [uid]: { name, pfp: pfp || "", cid } }, updated: serverTimestamp() }, { merge: true });
            document.getElementById('searchOverlay').style.display = 'none';
            openRoom(rid, name, pfp, cid, 'chats');
        }

        window.openRoom = (id, name, pfp, cid, type) => {
            activeRoom = id;
            document.getElementById('chatName').innerText = name;
            document.getElementById('chatPfp').src = pfp || 'https://via.placeholder.com/50';
            document.getElementById('chatId').innerText = cid === 'Group' ? 'Public' : 'ID: ' + cid;
            document.getElementById('chatScreen').classList.add('active');
            if(msgUnsub) msgUnsub();
            const q = query(collection(db, type, id, "messages"), orderBy("createdAt", "asc"));
            msgUnsub = onSnapshot(q, snap => {
                const stream = document.getElementById('msgStream');
                stream.innerHTML = '';
                snap.forEach(mDoc => {
                    const m = mDoc.data();
                    const div = document.createElement('div');
                    div.className = `bubble ${m.senderId === me.uid ? 'me' : 'other'}`;
                    div.innerHTML = m.image ? `<img src="${m.image}" style="width:100%;border-radius:10px;">` : m.text;
                    stream.appendChild(div);
                });
                stream.scrollTop = stream.scrollHeight;
            });
        };

        document.getElementById('sendBtn').onclick = async () => {
            const box = document.getElementById('typeBox');
            if(!box.value.trim() || !activeRoom) return;
            const type = document.getElementById('chatId').innerText === 'Public' ? 'groups' : 'chats';
            await addDoc(collection(db, type, activeRoom, "messages"), { senderId: me.uid, text: box.value, createdAt: serverTimestamp() });
            if(type === 'chats') await updateDoc(doc(db, "chats", activeRoom), { lastMsg: box.value, updated: serverTimestamp() });
            box.value = '';
        };

        window.joinGroup = async (gid) => {
            const gRef = doc(db, "groups", gid);
            await updateDoc(gRef, { members: arrayUnion(me.uid) });
        };

        window.createGroup = async () => {
            const n = prompt("Group Name:");
            if(n) await addDoc(collection(db, "groups"), { name: n, members: [me.uid], createdAt: serverTimestamp() });
        };

        function loadDirects() {
            onSnapshot(query(collection(db, "chats"), where("participants", "array-contains", me.uid)), snap => {
                const area = document.getElementById('directArea');
                area.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const otherId = data.participants.find(i => i !== me.uid);
                    const other = data.uData[otherId];
                    const div = document.createElement('div');
                    div.className = 'item-card';
                    div.innerHTML = `<img src="${other.pfp || 'https://via.placeholder.com/50'}" class="pfp"><div class="meta"><h4>${other.name}</h4><p>${data.lastMsg}</p></div>`;
                    div.onclick = () => openRoom(d.id, other.name, other.pfp, other.cid, 'chats');
                    area.appendChild(div);
                });
            });
        }

        function loadGroups() {
            onSnapshot(collection(db, "groups"), snap => {
                const area = document.getElementById('groupsArea');
                area.innerHTML = '';
                snap.forEach(d => {
                    const g = d.data();
                    const gid = d.id;
                    const members = g.members || [];
                    const isMember = members.includes(me.uid);
                    
                    const div = document.createElement('div');
                    div.className = 'item-card';
                    div.innerHTML = `
                        <div class="pfp" style="background:var(--primary);display:flex;align-items:center;justify-content:center;color:white;">${g.name[0]}</div>
                        <div class="meta"><h4>${g.name}</h4><p>${members.length} members</p></div>
                        ${isMember ? 
                            `<button class="action-btn joined-btn">Joined</button>` : 
                            `<button class="action-btn join-btn" onclick="joinGroup('${gid}')">Join</button>`
                        }`;
                    
                    div.onclick = (e) => {
                        if(e.target.tagName !== 'BUTTON') {
                            if(isMember) openRoom(gid, g.name, '', 'Group', 'groups');
                            else alert("Please join the group first!");
                        }
                    };
                    area.appendChild(div);
                });
            });
        }

        window.closeChat = () => document.getElementById('chatScreen').classList.remove('active');
    </script>
</body>
</html>
