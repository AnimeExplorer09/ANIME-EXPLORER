<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Login - AnimeExplorer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #7c4dff;
            --primary-glow: rgba(124, 77, 255, 0.5);
            --accent: #00e5ff;
            --bg-dark: #050507;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body, html {
            width: 100%; height: 100%;
            font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: white;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Animated Mesh Background --- */
        .bg-container {
            position: fixed; inset: 0; z-index: -1;
            background: radial-gradient(circle at 50% 50%, #12121c 0%, #050507 100%);
        }

        .blob {
            position: absolute; width: 400px; height: 400px;
            background: var(--primary);
            filter: blur(100px); border-radius: 50%; opacity: 0.2;
            animation: move 25s infinite alternate;
        }
        .blob-2 { background: var(--accent); animation-duration: 18s; right: 0; bottom: 0; }

        @keyframes move {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(150px, 100px) scale(1.3); }
        }

        /* --- Login Card Design --- */
        .login-card {
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            border-radius: 35px;
            padding: 50px 40px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            position: relative;
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.5);
            animation: cardEntrance 1s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes cardEntrance {
            from { opacity: 0; transform: scale(0.9) translateY(30px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .brand-logo {
            font-size: 36px; font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, var(--primary-light) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 8px; letter-spacing: -1.5px;
        }

        .subtitle { color: rgba(255,255,255,0.5); font-size: 14px; margin-bottom: 35px; }

        /* --- Stylish Inputs --- */
        .auth-form { display: flex; flex-direction: column; gap: 18px; }
        
        .input-group { position: relative; text-align: left; }
        .input-group i { 
            position: absolute; left: 18px; top: 50%; 
            transform: translateY(-50%); color: rgba(255,255,255,0.3);
            transition: 0.3s;
        }

        .input-group input {
            width: 100%; padding: 16px 16px 16px 52px;
            background: rgba(255,255,255,0.04);
            border: 1px solid transparent; border-radius: 18px;
            color: white; font-size: 15px; transition: 0.4s;
            outline: none;
        }

        .input-group input:focus {
            background: rgba(255,255,255,0.08);
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(124, 77, 255, 0.2);
        }

        .input-group input:focus + i { color: var(--primary); }

        /* --- Buttons --- */
        .login-btn {
            background: var(--primary);
            color: white; border: none; padding: 16px;
            border-radius: 18px; font-weight: 700; font-size: 16px;
            cursor: pointer; transition: 0.3s;
            box-shadow: 0 10px 25px var(--primary-glow);
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px var(--primary-glow);
        }

        .divider {
            display: flex; align-items: center; margin: 30px 0;
            color: rgba(255,255,255,0.2); font-size: 12px; font-weight: 600;
        }
        .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: rgba(255,255,255,0.1); margin: 0 15px; }

        .google-btn {
            background: white; color: #000;
            width: 100%; padding: 16px; border-radius: 18px;
            font-weight: 700; display: flex; align-items: center;
            justify-content: center; gap: 12px; border: none;
            cursor: pointer; transition: 0.3s;
        }

        .google-btn:hover { background: #f0f0f0; transform: scale(1.02); }

        #status {
            margin-top: 20px; font-size: 13px; font-weight: 500;
            min-height: 20px; color: var(--primary-light);
        }

        .footer-link {
            margin-top: 30px; font-size: 14px; color: rgba(255,255,255,0.4);
        }
        .footer-link a { color: var(--primary); text-decoration: none; font-weight: 700; transition: 0.3s; }
        .footer-link a:hover { color: var(--accent); }
    </style>
</head>
<body>

    <div class="bg-container">
        <div class="blob"></div>
        <div class="blob blob-2"></div>
    </div>

    <div class="login-card">
        <div class="brand-logo">AnimeExplorer</div>
        <p class="subtitle">Enter your credentials to continue</p>

        <div class="auth-form">
            <div class="input-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="email" placeholder="Email Address">
            </div>
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="password" placeholder="Password">
            </div>
            <button id="emailLoginBtn" class="login-btn">Sign In</button>
        </div>

        <div class="divider">OR CONTINUE WITH</div>

        <button id="loginBtn" class="google-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="22">
            <span>Google Account</span>
        </button>
        
        <p id="status"></p>

        <div class="footer-link">
            Don't have an account? <a href="signup.html">Create One</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDLd3TW-y89lwShUmcIHw3YGzDjo4cg3y4",
            authDomain: "animea2z.firebaseapp.com",
            projectId: "animea2z",
            storageBucket: "animea2z.firebasestorage.app",
            messagingSenderId: "673605765684",
            appId: "1:673605765684:web:a6f851e0d79836b79b1861"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        const status = document.getElementById('status');

        // 1. Email Login logic
        document.getElementById('emailLoginBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if(!email || !password) return status.innerText = "Please fill all fields";
            
            status.innerText = "Authenticating...";
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                await saveUser(userCredential.user);
                window.location.href = "index.html";
            } catch (e) { status.innerText = "Error: " + e.message; }
        });

        // 2. Google Redirect Result
        getRedirectResult(auth).then(async (result) => {
            if (result) {
                status.innerText = "Synchronizing data...";
                await saveUser(result.user);
                window.location.href = "index.html";
            }
        });

        document.getElementById('loginBtn').addEventListener('click', () => {
            signInWithRedirect(auth, provider);
        });

        // 3. User Sync Logic with Sequential ID
        async function saveUser(user) {
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);

            if (snap.exists()) {
                await updateDoc(userRef, { isOnline: true });
            } else {
                let customId = "1000001";
                try {
                    customId = await runTransaction(db, async (transaction) => {
                        const counterRef = doc(db, "settings", "userCounter");
                        const counterDoc = await transaction.get(counterRef);
                        let nextId = 1000001;
                        if (counterDoc.exists()) {
                            nextId = counterDoc.data().lastId + 1;
                        }
                        transaction.set(counterRef, { lastId: nextId });
                        return String(nextId);
                    });
                } catch (e) { customId = Date.now().toString().slice(-7); }

                await setDoc(userRef, {
                    uid: user.uid,
                    customId: customId,
                    username: user.displayName || user.email.split('@')[0],
                    email: user.email,
                    avatar: user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=7c4dff&color=fff`,
                    isOnline: true,
                    xp: 0,
                    joinedAt: new Date().toLocaleDateString()
                });
            }
        }
    </script>
</body>
</html>
