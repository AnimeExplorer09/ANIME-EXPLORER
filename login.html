<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Login - AnimeExplorer</title>
    <!-- CSS Wahi Purani -->
    <link rel="stylesheet" href="main.css">
    
    <style>
        .login-container {
            height: 100vh;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle at top, #1a237e 0%, #0f1014 70%);
            padding: 20px;
        }
        .login-logo {
            font-size: 36px; font-weight: 800; color: var(--primary); margin-bottom: 15px;
            letter-spacing: 2px; text-shadow: 0 0 20px rgba(124, 77, 255, 0.5);
        }
        .login-card {
            background: rgba(27, 29, 36, 0.8); padding: 40px 30px; border-radius: 20px;
            width: 100%; max-width: 350px; text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .google-btn {
            background: white; color: #333; width: 100%; padding: 12px;
            border-radius: 30px; font-weight: 700; display: flex; align-items: center; justify-content: center;
            gap: 12px; border: none; cursor: pointer; margin-top: 20px;
        }
        #status { margin-top: 15px; color: #ffeb3b; font-size: 12px; }
    </style>
</head>
<body>

    <div class="login-container">
        <div class="login-logo">AnimeExplorer</div>
        
        <div class="login-card">
            <h2 style="color: white; margin-bottom: 8px;">Welcome Back!</h2>
            <p style="color: #aaa; font-size: 14px; margin-bottom: 20px;">
                Sign in to sync your watchlist and chat.
            </p>

            <button id="loginBtn" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24">
                Sign in with Google
            </button>
            
            <p id="status"></p>
        </div>
    </div>

    <!-- DIRECT LOGIC (No External File Dependency) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDLd3TW-y89lwShUmcIHw3YGzDjo4cg3y4",
            authDomain: "animea2z.firebaseapp.com",
            projectId: "animea2z",
            storageBucket: "animea2z.firebasestorage.app",
            messagingSenderId: "673605765684",
            appId: "1:673605765684:web:a6f851e0d79836b79b1861"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        const btn = document.getElementById('loginBtn');
        const status = document.getElementById('status');

        // 1. CHECK REDIRECT RESULT (Page Load)
        getRedirectResult(auth)
            .then(async (result) => {
                if (result) {
                    status.innerText = "Login Success! Setting up profile...";
                    await saveUser(result.user);
                    window.location.href = "index.html";
                }
            })
            .catch((error) => {
                console.error(error);
                status.innerText = "Error: " + error.message;
            });

        // 2. BUTTON CLICK
        btn.addEventListener('click', () => {
            status.innerText = "Redirecting to Google...";
            signInWithRedirect(auth, provider).catch((error) => {
                status.innerText = "Error: " + error.message;
            });
        });

        // 3. DATABASE LOGIC (ID Generator)
        async function saveUser(user) {
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);

            if (snap.exists()) {
                await updateDoc(userRef, { isOnline: true });
            } else {
                // Generate ID
                let customId = "1000000000";
                try {
                    customId = await runTransaction(db, async (transaction) => {
                        const counterRef = doc(db, "settings", "userCounter");
                        const counterDoc = await transaction.get(counterRef);
                        let nextId = 1000000001;
                        if (counterDoc.exists()) {
                            nextId = counterDoc.data().lastId + 1;
                        }
                        transaction.set(counterRef, { lastId: nextId });
                        return String(nextId);
                    });
                } catch (e) {
                    console.error("ID Gen Error", e);
                    customId = Date.now().toString();
                }

                await setDoc(userRef, {
                    uid: user.uid,
                    customId: customId,
                    username: user.displayName,
                    email: user.email,
                    avatar: user.photoURL,
                    isOnline: true,
                    friends: []
                });
            }
        }
    </script>
</body>
</html>
